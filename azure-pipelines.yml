# YAML spec:
# https://aka.ms/yaml

name: Build & Test - Azure

trigger:
  branches:
    include:
      - master
  tags:
    include:
      - '*'

pr:
- master

jobs:

- job: PSKoans_CI_Linux
  pool:
    vmImage: ubuntu-latest

  steps:
  - template: templates/build-steps.yml

- job: PSKoans_CI_Windows
  pool:
    vmImage: windows-latest

  steps:
  - template: templates/build-steps.yml

- job: PSKoans_CI_MacOS
  pool:
    vmImage: macOS-latest

  steps:
  - template: templates/build-steps.yml

- job: PSKoans_Publish
  condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/')
  dependsOn:
    - PSKoans_CI_Linux
    - PSKoans_CI_Windows
    - PSKoans_CI_MacOS
  pool:
    vmImage: ubuntu-latest

  steps:
  - task: DownloadPipelineArtifact@2
    inputs:
      artifact: ExternalHelp
      path: '$(System.DefaultWorkingDirectory)/PSKoans/'

  - task: PowerShell@2
    displayName: 'Deploy to Gallery'

    inputs:
      targetType: 'filePath'
      arguments: $(PSApiKey)
      filePath: ./Build/Publish.ps1

      errorActionPreference: 'stop'
      failOnStderr: true
      pwsh: true
