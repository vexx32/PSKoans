# YAML spec:
# https://aka.ms/yaml

name: Build & Test - Azure

trigger:
  branches:
    include:
      - master
  tags:
    include:
      - '*'

pr:
- master

jobs:

- job: CI_Linux
  pool:
    vmImage: ubuntu-latest

  steps:
  - template: templates/build-steps.yml
  - task: PublishPipelineArtifact@1
    displayName: 'Publish Help Artifacts'
    inputs:
      path: '$(System.DefaultWorkingDirectory)/PSKoans/en-us'
      artifact: ExternalHelp

- job: CI_Windows
  pool:
    vmImage: windows-latest

  steps:
  - template: templates/build-steps.yml

- job: CI_MacOS
  pool:
    vmImage: macOS-latest

  steps:
  - template: templates/build-steps.yml

- job: PublishModule
  condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/')
  dependsOn:
    - CI_Linux
    - CI_Windows
    - CI_MacOS
  pool:
    vmImage: ubuntu-latest

  steps:
  - task: DownloadPipelineArtifact@2
    inputs:
      artifact: ExternalHelp
      path: '$(System.DefaultWorkingDirectory)/PSKoans/'

  - task: PowerShell@2
    displayName: 'Deploy to Gallery'

    inputs:
      targetType: 'filePath'
      arguments: $(PSApiKey)
      filePath: ./Build/Publish.ps1

      errorActionPreference: 'stop'
      failOnStderr: true
      pwsh: true
